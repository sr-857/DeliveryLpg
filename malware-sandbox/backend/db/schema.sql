-- PostgreSQL schema for Malware Analysis Sandbox
-- Designed with security, audit trails, and multi-tenancy in mind

-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
CREATE EXTENSION IF NOT EXISTS "btree_gist";

-- Tenancy Management
CREATE TABLE tenants (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    domain VARCHAR(255) UNIQUE NOT NULL,
    branding JSONB NOT NULL DEFAULT '{}',
    settings JSONB NOT NULL DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- User Management with RBAC
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL CHECK (role IN ('admin', 'analyst', 'readonly')),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    is_active BOOLEAN DEFAULT true,
    mfa_enabled BOOLEAN DEFAULT false,
    mfa_secret VARCHAR(255),
    last_login TIMESTAMP WITH TIME ZONE,
    password_changed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    failed_login_attempts INTEGER DEFAULT 0,
    locked_until TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- User Sessions
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) NOT NULL UNIQUE,
    ip_address INET NOT NULL,
    user_agent TEXT,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_accessed TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Analysis Profiles
CREATE TABLE analysis_profiles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    timeout_seconds INTEGER NOT NULL DEFAULT 300,
    memory_limit_mb INTEGER NOT NULL DEFAULT 2048,
    cpu_limit INTEGER NOT NULL DEFAULT 2,
    network_policy VARCHAR(50) NOT NULL CHECK (network_policy IN ('blocked', 'isolated', 'proxy', 'allowed')),
    enable_screenshots BOOLEAN DEFAULT true,
    enable_network_capture BOOLEAN DEFAULT true,
    enable_file_monitoring BOOLEAN DEFAULT true,
    enable_process_monitoring BOOLEAN DEFAULT true,
    enable_registry_monitoring BOOLEAN DEFAULT true,
    yara_rules TEXT[],
    custom_rules TEXT[],
    is_default BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_id, name)
);

-- File Samples
CREATE TABLE samples (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    filename VARCHAR(512) NOT NULL,
    original_filename VARCHAR(512) NOT NULL,
    file_size BIGINT NOT NULL,
    file_type VARCHAR(100),
    mime_type VARCHAR(255),
    md5_hash VARCHAR(32) NOT NULL,
    sha1_hash VARCHAR(40) NOT NULL,
    sha256_hash VARCHAR(64) NOT NULL UNIQUE,
    ssdeep_hash VARCHAR(255),
    file_content BYTEA,
    storage_path VARCHAR(1024),
    upload_date TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    uploaded_by UUID NOT NULL REFERENCES users(id),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    status VARCHAR(50) NOT NULL DEFAULT 'pending' CHECK (status IN ('uploading', 'pending', 'scanning', 'analyzing', 'completed', 'failed', 'quarantined')),
    tags TEXT[] DEFAULT '{}',
    notes TEXT,
    is_quarantined BOOLEAN DEFAULT false,
    quarantine_reason TEXT,
    metadata JSONB DEFAULT '{}',
    static_analysis JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Sample Hashes for quick lookup
CREATE INDEX idx_samples_sha256 ON samples(sha256_hash);
CREATE INDEX idx_samples_md5 ON samples(md5_hash);
CREATE INDEX idx_samples_tenant ON samples(tenant_id);
CREATE INDEX idx_samples_status ON samples(status);
CREATE INDEX idx_samples_upload_date ON samples(upload_date);

-- Analysis Jobs
CREATE TABLE analyses (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    sample_id UUID NOT NULL REFERENCES samples(id) ON DELETE CASCADE,
    profile_id UUID NOT NULL REFERENCES analysis_profiles(id),
    status VARCHAR(50) NOT NULL DEFAULT 'queued' CHECK (status IN ('queued', 'running', 'completed', 'failed', 'cancelled', 'timeout')),
    start_time TIMESTAMP WITH TIME ZONE,
    end_time TIMESTAMP WITH TIME ZONE,
    duration_seconds INTEGER,
    verdict VARCHAR(50) CHECK (verdict IN ('malicious', 'suspicious', 'benign', 'unknown')),
    score INTEGER CHECK (score >= 0 AND score <= 100),
    confidence INTEGER CHECK (confidence >= 0 AND confidence <= 100),
    analyst_id UUID REFERENCES users(id),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    environment JSONB DEFAULT '{}',
    configuration JSONB DEFAULT '{}',
    vm_id VARCHAR(255),
    priority INTEGER DEFAULT 2 CHECK (priority BETWEEN 1 AND 4),
    queue_position INTEGER,
    estimated_duration INTEGER,
    error_message TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_analyses_sample ON analyses(sample_id);
CREATE INDEX idx_analyses_status ON analyses(status);
CREATE INDEX idx_analyses_tenant ON analyses(tenant_id);
CREATE INDEX idx_analyses_verdict ON analyses(verdict);
CREATE INDEX idx_analyses_created ON analyses(created_at);

-- Analysis Reports
CREATE TABLE analysis_reports (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,
    summary JSONB DEFAULT '{}',
    static_analysis JSONB DEFAULT '{}',
    dynamic_analysis JSONB DEFAULT '{}',
    network_analysis JSONB DEFAULT '{}',
    yara_matches JSONB DEFAULT '{}',
    iocs JSONB DEFAULT '{}',
    screenshots JSONB DEFAULT '{}',
    events JSONB DEFAULT '{}',
    tags TEXT[] DEFAULT '{}',
    analyst_notes JSONB DEFAULT '{}',
    artifacts JSONB DEFAULT '{}',
    is_final BOOLEAN DEFAULT false,
    reviewed_at TIMESTAMP WITH TIME ZONE,
    reviewed_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(analysis_id)
);

-- Analysis Events (for timeline and replay)
CREATE TABLE analysis_events (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    event_category VARCHAR(100) NOT NULL,
    severity VARCHAR(50) NOT NULL CHECK (severity IN ('critical', 'high', 'medium', 'low', 'info')),
    description TEXT NOT NULL,
    process_id INTEGER,
    process_name VARCHAR(512),
    details JSONB DEFAULT '{}',
    tags TEXT[] DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_analysis_events_analysis ON analysis_events(analysis_id);
CREATE INDEX idx_analysis_events_timestamp ON analysis_events(timestamp);
CREATE INDEX idx_analysis_events_type ON analysis_events(event_type);
CREATE INDEX idx_analysis_events_severity ON analysis_events(severity);

-- YARA Rules and Matches
CREATE TABLE yara_rules (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    author VARCHAR(255),
    description TEXT,
    rule_content TEXT NOT NULL,
    tags TEXT[] DEFAULT '{}',
    meta JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    is_global BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_id, name)
);

CREATE TABLE yara_matches (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,
    rule_id UUID NOT NULL REFERENCES yara_rules(id),
    rule_name VARCHAR(255) NOT NULL,
    rule_author VARCHAR(255),
    rule_description TEXT,
    tags TEXT[] DEFAULT '{}',
    meta JSONB DEFAULT '{}',
    matches JSONB DEFAULT '{}',
    severity VARCHAR(50) NOT NULL CHECK (severity IN ('critical', 'high', 'medium', 'low', 'info')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_yara_matches_analysis ON yara_matches(analysis_id);
CREATE INDEX idx_yara_matches_rule ON yara_matches(rule_id);

-- IOCs (Indicators of Compromise)
CREATE TABLE iocs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,
    type VARCHAR(50) NOT NULL CHECK (type IN ('hash', 'ip_address', 'domain', 'url', 'email', 'file_path', 'registry_key', 'mutex', 'user_agent', 'certificate')),
    value VARCHAR(2048) NOT NULL,
    description TEXT,
    confidence INTEGER CHECK (confidence >= 0 AND confidence <= 100),
    context TEXT,
    source VARCHAR(255),
    tags TEXT[] DEFAULT '{}',
    is_false_positive BOOLEAN DEFAULT false,
    false_positive_reason TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_iocs_unique ON iocs(type, value, analysis_id);
CREATE INDEX idx_iocs_type ON iocs(type);
CREATE INDEX idx_iocs_value ON iocs(value);
CREATE INDEX idx_iocs_analysis ON iocs(analysis_id);

-- Screenshots
CREATE TABLE screenshots (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,
    filename VARCHAR(512) NOT NULL,
    title VARCHAR(512),
    description TEXT,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    width INTEGER,
    height INTEGER,
    file_size BIGINT,
    storage_path VARCHAR(1024),
    thumbnail_path VARCHAR(1024),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_screenshots_analysis ON screenshots(analysis_id);
CREATE INDEX idx_screenshots_timestamp ON screenshots(timestamp);

-- Artifacts
CREATE TABLE artifacts (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,
    type VARCHAR(100) NOT NULL CHECK (type IN ('memory_dump', 'disk_image', 'pcap', 'log_file', 'screenshot', 'extracted_file')),
    name VARCHAR(512) NOT NULL,
    description TEXT,
    path VARCHAR(2048),
    size BIGINT,
    hash VARCHAR(255),
    is_quarantined BOOLEAN DEFAULT false,
    quarantine_reason TEXT,
    approved_for_download BOOLEAN DEFAULT false,
    download_requested_by UUID REFERENCES users(id),
    download_approved_by UUID REFERENCES users(id),
    download_approved_at TIMESTAMP WITH TIME ZONE,
    storage_path VARCHAR(1024),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_artifacts_analysis ON artifacts(analysis_id);
CREATE INDEX idx_artifacts_type ON artifacts(type);
CREATE INDEX idx_artifacts_quarantined ON artifacts(is_quarantined);

-- Analyst Notes
CREATE TABLE analyst_notes (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,
    analyst_id UUID NOT NULL REFERENCES users(id),
    content TEXT NOT NULL,
    is_private BOOLEAN DEFAULT false,
    tags TEXT[] DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_analyst_notes_analysis ON analyst_notes(analysis_id);
CREATE INDEX idx_analyst_notes_analyst ON analyst_notes(analyst_id);

-- VM Management
CREATE TABLE vms (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    status VARCHAR(50) NOT NULL CHECK (status IN ('idle', 'busy', 'maintenance', 'error', 'offline')),
    os VARCHAR(100) NOT NULL,
    os_version VARCHAR(100),
    ip_address INET,
    mac_address VARCHAR(17),
    cpu_cores INTEGER,
    memory_mb INTEGER,
    disk_gb INTEGER,
    current_analysis UUID REFERENCES analyses(id),
    snapshot_id VARCHAR(255),
    last_heartbeat TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    uptime_seconds INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_vms_status ON vms(status);
CREATE INDEX idx_vms_current_analysis ON vms(current_analysis);

-- System Health Monitoring
CREATE TABLE system_health (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    cpu_usage DECIMAL(5,2),
    memory_usage DECIMAL(5,2),
    disk_usage DECIMAL(5,2),
    network_latency INTEGER,
    active_analysis_count INTEGER DEFAULT 0,
    queued_analysis_count INTEGER DEFAULT 0,
    total_analysis_count INTEGER DEFAULT 0,
    error_rate DECIMAL(5,2),
    uptime_seconds INTEGER,
    version VARCHAR(50)
);

CREATE INDEX idx_system_health_timestamp ON system_health(timestamp);

-- Audit Log (Immutable)
CREATE TABLE audit_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id),
    tenant_id UUID REFERENCES tenants(id),
    action VARCHAR(255) NOT NULL,
    resource_type VARCHAR(100) NOT NULL,
    resource_id UUID,
    old_values JSONB,
    new_values JSONB,
    ip_address INET,
    user_agent TEXT,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    session_id UUID REFERENCES user_sessions(id)
);

CREATE INDEX idx_audit_log_user ON audit_log(user_id);
CREATE INDEX idx_audit_log_tenant ON audit_log(tenant_id);
CREATE INDEX idx_audit_log_action ON audit_log(action);
CREATE INDEX idx_audit_log_timestamp ON audit_log(timestamp);

-- Job Queue
CREATE TABLE job_queue (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    sample_id UUID NOT NULL REFERENCES samples(id) ON DELETE CASCADE,
    analysis_id UUID REFERENCES analyses(id) ON DELETE CASCADE,
    profile_id UUID NOT NULL REFERENCES analysis_profiles(id),
    priority INTEGER DEFAULT 2 CHECK (priority BETWEEN 1 AND 4),
    status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'cancelled')),
    queue_time TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    start_time TIMESTAMP WITH TIME ZONE,
    estimated_completion TIMESTAMP WITH TIME ZONE,
    submitted_by UUID NOT NULL REFERENCES users(id),
    processing_vm UUID REFERENCES vms(id),
    error_message TEXT,
    retry_count INTEGER DEFAULT 0,
    max_retries INTEGER DEFAULT 3,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_job_queue_status ON job_queue(status);
CREATE INDEX idx_job_queue_priority ON job_queue(priority);
CREATE INDEX idx_job_queue_queue_time ON job_queue(queue_time);

-- Integrations
CREATE TABLE integrations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(100) NOT NULL CHECK (type IN ('webhook', 'slack', 'email', 'siem', 'threat_intel', 'ticketing')),
    configuration JSONB NOT NULL DEFAULT '{}',
    events TEXT[] DEFAULT '{}',
    filters JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    last_sync TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_id, name)
);

-- Notifications
CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    type VARCHAR(50) NOT NULL CHECK (type IN ('success', 'error', 'warning', 'info')),
    title VARCHAR(512) NOT NULL,
    message TEXT NOT NULL,
    data JSONB DEFAULT '{}',
    is_read BOOLEAN DEFAULT false,
    read_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_read ON notifications(is_read);
CREATE INDEX idx_notifications_created ON notifications(created_at);

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Create triggers for updated_at
CREATE TRIGGER update_tenants_updated_at BEFORE UPDATE ON tenants
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_analysis_profiles_updated_at BEFORE UPDATE ON analysis_profiles
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_samples_updated_at BEFORE UPDATE ON samples
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_analyses_updated_at BEFORE UPDATE ON analyses
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_analysis_reports_updated_at BEFORE UPDATE ON analysis_reports
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_analyst_notes_updated_at BEFORE UPDATE ON analyst_notes
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_vms_updated_at BEFORE UPDATE ON vms
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_yara_rules_updated_at BEFORE UPDATE ON yara_rules
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_integrations_updated_at BEFORE UPDATE ON integrations
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_job_queue_updated_at BEFORE UPDATE ON job_queue
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Row Level Security (RLS) for multi-tenancy
ALTER TABLE samples ENABLE ROW LEVEL SECURITY;
ALTER TABLE analyses ENABLE ROW LEVEL SECURITY;
ALTER TABLE analysis_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE analysis_events ENABLE ROW LEVEL SECURITY;
ALTER TABLE screenshots ENABLE ROW LEVEL SECURITY;
ALTER TABLE artifacts ENABLE ROW LEVEL SECURITY;
ALTER TABLE analyst_notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;

-- RLS Policies
CREATE POLICY tenant_isolation_samples ON samples
    FOR ALL TO authenticated_users
    USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

CREATE POLICY tenant_isolation_analyses ON analyses
    FOR ALL TO authenticated_users
    USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

CREATE POLICY tenant_isolation_analysis_reports ON analysis_reports
    FOR ALL TO authenticated_users
    USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

CREATE POLICY tenant_isolation_analysis_events ON analysis_events
    FOR ALL TO authenticated_users
    USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

CREATE POLICY tenant_isolation_screenshots ON screenshots
    FOR ALL TO authenticated_users
    USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

CREATE POLICY tenant_isolation_artifacts ON artifacts
    FOR ALL TO authenticated_users
    USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

CREATE POLICY tenant_isolation_analyst_notes ON analyst_notes
    FOR ALL TO authenticated_users
    USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

CREATE POLICY tenant_isolation_notifications ON notifications
    FOR ALL TO authenticated_users
    USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

-- Views for common queries
CREATE VIEW analysis_summary AS
SELECT
    a.id,
    a.status,
    a.verdict,
    a.score,
    a.start_time,
    a.end_time,
    a.duration_seconds,
    s.filename,
    s.file_size,
    s.sha256_hash,
    u.username as submitted_by,
    p.name as profile_name,
    a.created_at
FROM analyses a
JOIN samples s ON a.sample_id = s.id
JOIN users u ON a.analyst_id = u.id
JOIN analysis_profiles p ON a.profile_id = p.id;

CREATE VIEW recent_analyses AS
SELECT
    a.*,
    s.filename,
    s.file_size,
    s.sha256_hash
FROM analyses a
JOIN samples s ON a.sample_id = s.id
WHERE a.created_at >= CURRENT_DATE - INTERVAL '7 days'
ORDER BY a.created_at DESC;

-- Function to get tenant context
CREATE OR REPLACE FUNCTION set_tenant_context(tenant_uuid UUID)
RETURNS VOID AS $$
BEGIN
    PERFORM set_config('app.current_tenant_id', tenant_uuid::text, true);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to check user permissions
CREATE OR REPLACE FUNCTION has_permission(user_uuid UUID, permission TEXT)
RETURNS BOOLEAN AS $$
DECLARE
    user_role TEXT;
BEGIN
    SELECT role INTO user_role FROM users WHERE id = user_uuid;

    -- Admin has all permissions
    IF user_role = 'admin' THEN
        RETURN TRUE;
    END IF;

    -- Check specific permissions for analyst
    IF user_role = 'analyst' THEN
        RETURN permission IN ('view_samples', 'upload_samples', 'run_analysis', 'view_reports', 'export_reports');
    END IF;

    -- Readonly has limited permissions
    IF user_role = 'readonly' THEN
        RETURN permission = 'view_samples';
    END IF;

    RETURN FALSE;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;